# MarkLight 架构设计

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         应用层 (Vue 3)                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │ App.vue     │ │ Toolbar     │ │ StatusBar   │ │ Outline   │ │
│  │ (入口组件)   │ │ (工具栏)     │ │ (状态栏)    │ │ (大纲)    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      编辑器核心 (ProseMirror)                     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    MarkdownEditor.vue                       ││
│  │  ┌─────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ││
│  │  │ Schema  │  │ Plugins   │  │ NodeViews │  │ State     │  ││
│  │  │ (节点定义)│  │ (功能插件) │  │ (自定义渲染)│  │ (文档状态) │  ││
│  │  └─────────┘  └───────────┘  └───────────┘  └───────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层                                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ Pinia Store │ │ MD 解析/序列化│ │ 微信渲染器   │               │
│  │ (file.ts)   │ │ (markdown.ts)│ │ (wechat-*)  │               │
│  └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      平台层 (Tauri 2.0)                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ 文件系统 API │ │ 系统对话框   │ │ 原生菜单事件  │               │
│  │ (fs plugin) │ │ (dialog)    │ │ (menu-event)│               │
│  └─────────────┘ └─────────────┘ └─────────────┘               │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 核心数据流

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ Markdown 文件 │ ──▶ │ read_file    │ ──▶ │ Pinia Store  │
│ (.md)        │     │ (Rust)       │     │ (file.ts)    │
└──────────────┘     └──────────────┘     └──────────────┘
                                                   │
                                                   ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ 渲染视图      │ ◀── │ ProseMirror  │ ◀── │ parseMarkdown│
│ (Vue)        │     │ EditorState  │     │ (AST 转换)   │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
┌──────────────┐     ┌──────────────┐
│ 用户编辑      │ ──▶ │ Transaction  │
│ (输入/删除)   │     │ (事务处理)   │
└──────────────┘     └──────────────┘
                            │
                            ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ serializeMD  │ ──▶ │ save_file    │ ──▶ │ Markdown 文件 │
│ (序列化)     │     │ (Rust)       │     │ (.md)        │
└──────────────┘     └──────────────┘     └──────────────┘
```

## 3. 插件系统

编辑器通过 ProseMirror 插件系统实现功能扩展：

| 插件 | 文件 | 功能 |
|------|------|------|
| `highlightPlugin` | `highlight.ts` | 代码块语法高亮 |
| `createBubbleMenuPlugin` | `bubble-menu.ts` | 选中文本时显示格式化菜单 |
| `createImageHandlePlugin` | `image-handle.ts` | 图片拖拽、粘贴处理 |
| `smartPaste` | `smart-paste.ts` | 智能粘贴（URL 转链接等） |
| `tableEditing` | prosemirror-tables | 表格编辑支持 |
| `columnResizing` | prosemirror-tables | 表格列宽调整 |
| `history` | prosemirror-history | 撤销/重做 |
| `inputRules` | prosemirror-inputrules | 输入规则（# 转 H1 等） |
| `keymap` | prosemirror-keymap | 快捷键绑定 |

## 4. NodeView 系统

自定义节点使用 Vue 组件渲染：

| NodeView | Vue 组件 | 功能 |
|----------|----------|------|
| `code_block` | `CodeBlockView.vue` | 代码块编辑、语言选择、高亮 |
| `image` | `ImageView.vue` | 图片预览、缩放、路径处理 |
| `math_inline` | `MathView.vue` | 行内数学公式编辑与渲染 |
| `math_block` | `MathView.vue` | 块级数学公式编辑与渲染 |

## 5. 状态管理

```typescript
// stores/file.ts
interface FileState {
  path: string | null;    // 文件路径
  content: string;        // Markdown 内容
  isDirty: boolean;       // 是否有未保存更改
}

// 核心方法
- setFile(content, path)  // 设置文件内容
- setContent(content)     // 更新内容（标记 dirty）
- markSaved()             // 标记已保存
- reset()                 // 重置为新文件
```

## 6. 微信导出逻辑

```
ProseMirror Document
        │
        ▼
┌───────────────────┐
│ renderToWechatHtml│
│ (wechat-renderer) │
└───────────────────┘
        │
        ▼
┌───────────────────┐
│ 遍历 AST 节点      │
│ 注入 Inline Styles│
└───────────────────┘
        │
        ▼
┌───────────────────┐
│ Clipboard API     │
│ 复制到剪贴板       │
└───────────────────┘
```

## 7. 性能优化策略

- **防抖更新**：`debounce(400ms)` 处理大纲更新和字数统计
- **即时更新**：光标位置变化立即响应（无防抖）
- **惰性渲染**：NodeView 只在需要时创建
- **差异化更新**：只在 `docChanged` 或 `selectionSet` 时触发重计算